# üìò **DOCUMENTO INTEGRADO DE REQUISITOS MAYORES DEL SISTEMA EMBEBIDO**

**Versi√≥n:** 2.0
**Proyecto:** Datalogger ESP32-S3 + SIM7080 para agricultura inteligente
**Prop√≥sito:** Definir el comportamiento obligatorio del sistema embebido para asegurar **lectura continua, almacenamiento seguro, transmisi√≥n eficiente, resiliencia energ√©tica y modularidad extrema**.

---

# 0. **Principios Rectores del Sistema**

## **PRINC-01 ‚Äî Prioridad absoluta a adquisici√≥n + almacenamiento**

Mientras el sistema est√© energizado, **el almacenamiento local de datos tendr√° prioridad sobre la transmisi√≥n**, sin excepci√≥n. Ninguna falla de red, energ√≠a o m√≥dem podr√° interrumpir la captura y persistencia de datos.

## **PRINC-02 ‚Äî Continuidad operativa aun en fallos cr√≠ticos**

El sistema deber√° **seguir leyendo y almacenando datos incluso en fallos severos** (sin red, m√≥dem corrupto, reconexi√≥n fallida, reinicios, etc.) sin comprometer la integridad de datos.

## **PRINC-03 ‚Äî Dise√±o modular y escalable**

La arquitectura deber√° permitir **integrar nuevos sensores RS-485, I¬≤C, 1-Wire, ADC u otros sin refactorizar el n√∫cleo** de adquisici√≥n, almacenamiento o transmisi√≥n.

---

# 1. **Requisitos funcionales ‚Äì Adquisici√≥n**

## **RF-01 ‚Äî Lectura continua de sensores RS-485**

**Mientras** el bus RS-485 est√© operativo,
**el subsistema de adquisici√≥n del ESP32-S3**
**deber√°**
**leer**
**cada medici√≥n de cada sensor Modbus**,
**si y solo si** responden frames v√°lidos,
**criterio:** tasa m√≠nima de √©xito del 98 % en 3 intentos consecutivos.
(Drivers RS-485 y l√≠neas A/B validadas contra esquem√°tico modelo6) 

---

## **RF-02 ‚Äî Lectura continua de sensores locales (ADC, GPIO, I¬≤C)**

**Mientras** exista un ciclo de lectura programado por RTC,
**el subsistema local de adquisici√≥n**
**deber√°**
**capturar**
**cada sensor conectado (E/S1, ADC, DHT-ADC1, etc.)**,
**independientemente** del estado del m√≥dem,
**criterio:** la transmisi√≥n no podr√° bloquear adquisici√≥n m√°s de 50 ms por ciclo.

---

## **RF-03 ‚Äî Interfaz abstracta para sensores (modularidad total)**

**El sistema de firmware**
**deber√°**
**proveer**
**una interfaz unificada de sensor** (init, read, validate, pack)
**para permitir integrar nuevos sensores** sin modificar el n√∫cleo,
**criterio:** la adici√≥n de un nuevo sensor no deber√° cambiar m√°s del 5 % del c√≥digo del core.

---

# 2. **Requisitos funcionales ‚Äì Almacenamiento (n√∫cleo del sistema)**

## **RF-04 ‚Äî Almacenamiento transaccional de mediciones**

**Despu√©s de que** se obtenga una medici√≥n v√°lida,
**el subsistema de almacenamiento**
**deber√°**
**escribir at√≥micamente**
**un registro con:** timestamp RTC, sensor ID, valor, calidad y n√∫mero de intento,
**criterio:** ninguna operaci√≥n podr√° corromper registros previos.

---

## **RF-05 ‚Äî Logs cr√≠ticos persistentes**

**Cuando** ocurra un fallo cr√≠tico (watchdog, brown-out, m√≥dem, RS-485),
**el subsistema de registro**
**deber√°**
**almacenar**
**un log cr√≠tico** con contexto m√≠nimo,
**criterio:** conservar al menos los √∫ltimos 10 eventos, aun tras reinicios.

---

## **RF-06 ‚Äî Modo "solo adquisici√≥n y almacenamiento" por baja bater√≠a**

**Si** el nivel de bater√≠a cae por debajo del **Umbral de Transmisi√≥n Segura (UTS)**,
**el subsistema de energ√≠a**
**deber√°**
**desactivar el m√≥dem**
**y mantener √∫nicamente adquisici√≥n + almacenamiento**,
**criterio:** operar m√≠nimo 24 h en este modo sin perder datos.

---

# 3. **Requisitos funcionales ‚Äì Transmisi√≥n (subordinada al almacenamiento)**

## **RF-07 ‚Äî Transmisi√≥n no bloqueante**

**Si** el m√≥dem tiene red y la bater√≠a > UTS,
**el subsistema de comunicaciones**
**deber√°**
**transmitir**
**los datos pendientes sin bloquear adquisici√≥n**,
**criterio:** fallas de m√≥dem no deben impedir almacenamiento continuo.

---

## **RF-08 ‚Äî Pol√≠tica de borrado solo tras ACK**

**Despu√©s de que** el servidor confirme recepci√≥n,
**el sistema**
**deber√°**
**eliminar √∫nicamente** los registros confirmados,
**criterio:** ning√∫n dato podr√° borrarse sin confirmaci√≥n expl√≠cita.

---

## **RF-09 ‚Äî Reanudaci√≥n de transmisi√≥n condicionada a recuperaci√≥n de carga**

**Despu√©s de que** la bater√≠a supere UTS durante un periodo estable (ej. 10 min),
**el subsistema de energ√≠a**
**deber√°**
**autorizar**
la reactivaci√≥n del m√≥dem,
**criterio:** evitar ciclos r√°pidos ON/OFF del SIM7080 (basado en dise√±o modelo6) 

---

# 4. **Requisitos funcionales ‚Äì Selecci√≥n inteligente de operador celular**

## **RF-10 ‚Äî Descubrimiento de operadores disponibles**

**Cuando** el m√≥dem SIM7080 encienda,
**el subsistema de comunicaciones**
**deber√°**
**solicitar la lista de operadores disponibles**,
**criterio:** completar el escaneo en < 60 s.

---

## **RF-11 ‚Äî Conexi√≥n prioritaria con operador previamente exitoso**

**Si** existe un operador preferido en memoria persistente
**y** se detecta su disponibilidad,
**el sistema**
**deber√°**
**intentar conectarse primero a ese operador**,
**criterio:** evitar escaneos repetidos innecesarios para ahorrar energ√≠a.

---

## **RF-12 ‚Äî Selecci√≥n del mejor operador si el preferido falla**

**Si** el intento de conexi√≥n falla
**y** hay m√∫ltiples operadores,
**el sistema**
**deber√°**
**evaluar**
RSSI, estabilidad y disponibilidad
**y seleccionar el m√°s adecuado**,
**criterio:** el algoritmo deber√° limitar consultas de se√±al para no comprometer consumo energ√©tico.

---

## **RF-13 ‚Äî Memorizaci√≥n persistente del operador exitoso**

**Despu√©s de que** se establezca una conexi√≥n exitosa,
**el subsistema de comunicaciones**
**deber√°**
**almacenar en memoria persistente** el operador usado,
**criterio:** tras reinicio completo, el sistema deber√° intentar conectarse primero a ese operador.

---

## **RF-14 ‚Äî Limitaci√≥n energ√©tica de escaneos de operador**

**En caso de que** sea necesario escanear operadores,
**el sistema**
**deber√°**
**limitar** la frecuencia de escaneos completos,
**criterio:** m√°ximo 3 escaneos/d√≠a salvo eventos excepcionales.

---

# 5. **Requisitos funcionales ‚Äì Recuperaci√≥n y resiliencia**

## **RF-15 ‚Äî Autorestablecimiento controlado**

**Si** ocurre un estado cr√≠tico (m√≥dem colgado, RS-485 sin respuesta, fallos repetidos),
**el subsistema de supervisi√≥n**
**deber√°**
**ejecutar un protocolo de recuperaci√≥n**
(restaurar UART, reiniciar m√≥dem, reinicio parcial o total),
**criterio:** recuperar modo adquisici√≥n + almacenamiento en <120 s conservando datos.

---

## **RF-16 ‚Äî Extracci√≥n de datos y logs por puerto serie**

**Cuando** un operador ingrese al modo mantenimiento por serial,
**el subsistema de diagn√≥stico**
**deber√°**
**exportar**
todos los datos almacenados + los logs cr√≠ticos
**sin borrar** la memoria interna,
**criterio:** extracci√≥n completa posible incluso con m√≥dem da√±ado.

---

## **RF-17 ‚Äî Consulta interactiva del estado del sistema por serial**

**Mientras** el modo mantenimiento est√© activo,
**el sistema**
**deber√°**
**proveer comandos** para consultar bater√≠a, RTC, tama√±o de memoria usada, estado del m√≥dem, cola de transmisi√≥n,
**criterio:** respuesta < 2 s por comando.

---

# 6. **Requisitos no funcionales ‚Äì Energ√≠a, disponibilidad y seguridad**

## **RNF-01 ‚Äî Consumo m√≠nimo en deep sleep**

El sistema deber√° mantenerse por debajo de 300 ¬µA en deep-sleep, conservando RTC y memoria.

---

## **RNF-02 ‚Äî Protecci√≥n ante fluctuaciones (brown-out)**

**Si** el voltaje cae bajo el Umbral M√≠nimo Operativo (UMO),
**el sistema**
**deber√°**
**entrar** en modo seguro,
**criterio:** ninguna escritura en memoria podr√° quedar incompleta.

---

## **RNF-03 ‚Äî Cifrado de datos**

Todo env√≠o deber√° ir cifrado (TLS 1.2+).
**Criterio:** handshake < 8 s en 80 % de pruebas.

---

# 7. **Requisitos de interfaz (hardware/firmware)**

## **RI-01 ‚Äî UART ESP32 ‚Üî SIM7080**

**Cuando** el sistema inicializa,
**deber√°** configurar UART1 (115200 8N1)
**y completar la secuencia correcta de PowerKey** documentada por SIMCom,
**criterio:** m√≥dem responde `AT` < 500 ms.
(Basado en Q1/Q2 del esquem√°tico SIM7080) 

---

## **RI-02 ‚Äî Control DE/RE RS-485**

**Mientras** RS-485 est√© activo,
el sistema deber√° administrar DE/RE mediante IO16/IO15
**criterio:** switching DE‚ÜîRE < 10 ¬µs.

---

# 8. **Requisitos ambientales**

## **REA-01 ‚Äî Operaci√≥n rural extrema**

El sistema deber√° operar en:

* Temperatura: ‚Äì10 ¬∞C a 60 ¬∞C
* Humedad: 5‚Äì95 %
  **criterio:** funcionamiento continuo ‚â• 30 d√≠as sin intervenci√≥n.

---

# ‚úîÔ∏è **DOCUMENTO INTEGRADO COMPLETO ‚Äì LISTO PARA USO EN SRS IEEE 29148**

Si quieres, ahora puedo generarte:

### ‚úîÔ∏è 1. **El SRS completo en formato IEEE 29148** (con secciones, glosarios, restricciones, supuestos).

### ‚úîÔ∏è 2. **La arquitectura formal del firmware** (m√°quina de estados + m√≥dulos + colas + drivers).

### ‚úîÔ∏è 3. **El modelo SysML de requisitos** (diagrama de requisitos + trazabilidad).

¬øQu√© deseas como siguiente paso?
